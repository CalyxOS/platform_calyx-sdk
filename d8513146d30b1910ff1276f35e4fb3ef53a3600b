{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "e74113e3_160d244e",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1000062
      },
      "writtenOn": "2023-07-06T13:10:05Z",
      "side": 1,
      "message": "Finally an explanation for the issue we were seeing before:\n\nWhen SQLiteOpenHelper calls onUpgrade, it does so [within a transaction of its own](https://cs.android.com/android/platform/superproject/+/android-13.0.0_r54:frameworks/base/core/java/android/database/sqlite/SQLiteOpenHelper.java;l\u003d408-423).\n\nTransactions can be nested, but if any nested transaction fails, the whole outer transaction will be rolled back. (So much for nesting...)\n\nAnd when we were reading a value within a transaction, we were not setting that transaction as successful. So it failed the entire outer upgrade transaction, rolling it back.\n\nHere\u0027s the [doc for beginTransaction](https://cs.android.com/android/platform/superproject/+/android-13.0.0_r54:frameworks/base/core/java/android/database/sqlite/SQLiteDatabase.java;l\u003d626-633):\n```\n     * Begins a transaction in EXCLUSIVE mode.\n     * \u003cp\u003e\n     * Transactions can be nested.\n     * When the outer transaction is ended all of\n     * the work done in that transaction and all of the nested transactions will be committed or\n     * rolled back. The changes will be rolled back if any transaction is ended without being\n     * marked as clean (by calling setTransactionSuccessful). Otherwise they will be committed.\n```",
      "revId": "d8513146d30b1910ff1276f35e4fb3ef53a3600b",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "4b432379_be08cad5",
        "filename": "packages/LineageSettingsProvider/src/org/lineageos/lineagesettings/LineageDatabaseHelper.java",
        "patchSetId": 1
      },
      "lineNbr": 666,
      "author": {
        "id": 1000000
      },
      "writtenOn": "2023-07-06T13:49:16Z",
      "side": 1,
      "message": "This does something similar to writeSetting",
      "revId": "d8513146d30b1910ff1276f35e4fb3ef53a3600b",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "8adef351_1d413162",
        "filename": "packages/LineageSettingsProvider/src/org/lineageos/lineagesettings/LineageDatabaseHelper.java",
        "patchSetId": 1
      },
      "lineNbr": 734,
      "author": {
        "id": 1000062
      },
      "writtenOn": "2023-07-06T13:04:21Z",
      "side": 1,
      "message": "Add db transactions for writing",
      "revId": "d8513146d30b1910ff1276f35e4fb3ef53a3600b",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "be367102_82ab07bd",
        "filename": "packages/LineageSettingsProvider/src/org/lineageos/lineagesettings/LineageDatabaseHelper.java",
        "patchSetId": 1
      },
      "lineNbr": 734,
      "author": {
        "id": 1000000
      },
      "writtenOn": "2023-07-06T13:49:16Z",
      "side": 1,
      "message": "Should we do that here though or leave it upto the caller",
      "parentUuid": "8adef351_1d413162",
      "revId": "d8513146d30b1910ff1276f35e4fb3ef53a3600b",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "8e7559a1_4369de7b",
        "filename": "packages/LineageSettingsProvider/src/org/lineageos/lineagesettings/LineageDatabaseHelper.java",
        "patchSetId": 1
      },
      "lineNbr": 734,
      "author": {
        "id": 1000062
      },
      "writtenOn": "2023-07-06T13:54:13Z",
      "side": 1,
      "message": "For what it\u0027s worth, AOSP simulates nested transactions on its own rather than using e.g. sqlite\u0027s SAVEPOINT feature. That\u0027s why they work a bit unexpectedly, with one failure rolling back the entire outer transaction.\n\nAdding them here should be a no-op, except in the case that we don\u0027t set the transaction successful.\n\nWe can still do it for consistency and lose nothing but a few CPU cycles, as long as we always set the transaction as successful.",
      "parentUuid": "8adef351_1d413162",
      "revId": "d8513146d30b1910ff1276f35e4fb3ef53a3600b",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b08e38d8_d0db954d",
        "filename": "packages/LineageSettingsProvider/src/org/lineageos/lineagesettings/LineageDatabaseHelper.java",
        "patchSetId": 1
      },
      "lineNbr": 734,
      "author": {
        "id": 1000000
      },
      "writtenOn": "2023-07-06T23:11:23Z",
      "side": 1,
      "message": "Ack",
      "parentUuid": "8e7559a1_4369de7b",
      "revId": "d8513146d30b1910ff1276f35e4fb3ef53a3600b",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "05204696_23e03a38",
        "filename": "packages/LineageSettingsProvider/src/org/lineageos/lineagesettings/LineageDatabaseHelper.java",
        "patchSetId": 1
      },
      "lineNbr": 734,
      "author": {
        "id": 1000000
      },
      "writtenOn": "2023-07-06T23:37:59Z",
      "side": 1,
      "message": "It\u0027s fine without since a transaction isn\u0027t of much use if we always set it as successful - it\u0027d never roll back!\n\nUnless it crashed in a way that didn\u0027t get caught.",
      "parentUuid": "b08e38d8_d0db954d",
      "revId": "d8513146d30b1910ff1276f35e4fb3ef53a3600b",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "1202eb60_0f5491d3",
        "filename": "packages/LineageSettingsProvider/src/org/lineageos/lineagesettings/LineageDatabaseHelper.java",
        "patchSetId": 1
      },
      "lineNbr": 736,
      "author": {
        "id": 1000000
      },
      "writtenOn": "2023-07-06T13:49:16Z",
      "side": 1,
      "message": "This is fine but what about just having two methods so that it\u0027s clearer.\n\nMinor nit / just semantics anyways.",
      "revId": "d8513146d30b1910ff1276f35e4fb3ef53a3600b",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "509e64cf_053aaa63",
        "filename": "packages/LineageSettingsProvider/src/org/lineageos/lineagesettings/LineageDatabaseHelper.java",
        "patchSetId": 1
      },
      "lineNbr": 736,
      "author": {
        "id": 1000000
      },
      "writtenOn": "2023-07-06T23:37:59Z",
      "side": 1,
      "message": "It\u0027s fine.",
      "parentUuid": "1202eb60_0f5491d3",
      "revId": "d8513146d30b1910ff1276f35e4fb3ef53a3600b",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    }
  ]
}